@using MudBlazor
@using GrapheneTrace.Client.Models

<MudDialog>
    <DialogContent>
        <MudForm @ref="form" Model="model">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h6" Class="fw-bold">Change Password</MudText>
                <MudText Typo="Typo.body2" Class="text-secondary">
                    Enter your current password and choose a new secure password.
                </MudText>

                <MudTextField T="string" 
                              @bind-Value="model.CurrentPassword"
                              Label="Current Password"
                              Variant="Variant.Outlined"
                              InputType="InputType.Password"
                              Required="true"
                              For="() => model.CurrentPassword"
                              Immediate="true" />

                <MudTextField T="string" 
                              @bind-Value="model.NewPassword"
                              Label="New Password"
                              Variant="Variant.Outlined"
                              InputType="InputType.Password"
                              Required="true"
                              For="() => model.NewPassword"
                              Immediate="true"
                              HelperText="Must be at least 6 characters long" />

                <MudTextField T="string" 
                              @bind-Value="model.ConfirmPassword"
                              Label="Confirm New Password"
                              Variant="Variant.Outlined"
                              InputType="InputType.Password"
                              Required="true"
                              For="() => model.ConfirmPassword"
                              Immediate="true" />

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Dense="true">@_errorMessage</MudAlert>
                }
            </MudStack>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="Cancel" Disabled="@_saving">
            Cancel
        </MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Save" Disabled="@_saving">
            @if (_saving)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                <MudText Class="ms-2">Updating...</MudText>
            }
            else
            {
                <text>Update Password</text>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private MudForm? form;
    private bool _saving = false;
    private string? _errorMessage;

    [CascadingParameter]
    private MudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public ChangePasswordModel model { get; set; } = new();

    private async Task Save()
    {
        _errorMessage = null;

        if (form == null)
        {
            return;
        }

        await form.Validate();

        if (!form.IsValid)
        {
            return;
        }

        if (string.IsNullOrWhiteSpace(model.CurrentPassword))
        {
            _errorMessage = "Current password is required.";
            StateHasChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(model.NewPassword))
        {
            _errorMessage = "New password is required.";
            StateHasChanged();
            return;
        }

        if (model.NewPassword.Length < 6)
        {
            _errorMessage = "New password must be at least 6 characters long.";
            StateHasChanged();
            return;
        }

        if (model.NewPassword != model.ConfirmPassword)
        {
            _errorMessage = "New password and confirm password do not match.";
            StateHasChanged();
            return;
        }

        _saving = true;
        StateHasChanged();

        MudDialog.Close(DialogResult.Ok(model));
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
