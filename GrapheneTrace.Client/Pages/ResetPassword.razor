@page "/reset-password"
@layout AuthenticationLayout
@using GrapheneTrace.Client.Services
@using System.ComponentModel.DataAnnotations
@inject AppToastService ToastService
@inject NavigationManager NavigationManager

<div class="w-full flex justify-center">
    <section class="w-full max-w-lg">
        <div class="bg-white shadow-2xl rounded-3xl border border-slate-100 px-8 py-10 space-y-8">
            <div class="space-y-4">
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-slate-700" for="email">Registered email</label>
                    <input id="email"
                           type="email"
                           class="w-full rounded-xl border border-slate-300 px-4 py-3 text-slate-700 placeholder-slate-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="you@organization.com"
                           @bind="Email"
                           maxlength="100" />
                    <p class="text-xs text-slate-500">Enter the email associated with your account.</p>
                </div>

                @if (!EmailVerified)
                {
                    <button class="w-full rounded-xl bg-blue-600 text-white font-semibold tracking-wide py-3 shadow-lg hover:bg-blue-700 transition" @onclick="VerifyEmail">Verify Email</button>
                }
                else
                {
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-700" for="newPassword">New password</label>
                        <input id="newPassword"
                               type="password"
                               class="w-full rounded-xl border border-slate-300 px-4 py-3 text-slate-700 placeholder-slate-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Enter a new password"
                               @bind="NewPassword"
                               maxlength="50" />
                        <p class="text-xs text-slate-500">At least 6 characters. Avoid reusing previous passwords.</p>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-700" for="confirmPassword">Confirm password</label>
                        <input id="confirmPassword"
                               type="password"
                               class="w-full rounded-xl border border-slate-300 px-4 py-3 text-slate-700 placeholder-slate-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Re-enter your new password"
                               @bind="ConfirmPassword"
                               maxlength="50" />
                        <p class="text-xs text-slate-500">We will check that both entries match.</p>
                    </div>

                    <button class="w-full rounded-xl bg-blue-600 text-white font-semibold tracking-wide py-3 shadow-lg hover:bg-blue-700 transition" @onclick="ChangePassword">Reset Password</button>
                }
            </div>

            <a href="/login" class="block text-center rounded-xl border border-slate-300 text-slate-600 font-semibold py-3 hover:bg-slate-100 transition">Back to Login</a>
        </div>
    </section>
</div>

@code {
    private string Email { get; set; } = string.Empty;
    private string NewPassword { get; set; } = string.Empty;
    private string ConfirmPassword { get; set; } = string.Empty;
    private string Message { get; set; } = string.Empty;
    private bool EmailVerified { get; set; } = false;

    private bool ValidateEmailOnly()
    {
        if (string.IsNullOrWhiteSpace(Email))
        {
            Message = "Email cannot be empty.";
            return false;
        }
        if (!new EmailAddressAttribute().IsValid(Email))
        {
            Message = "Invalid email format.";
            return false;
        }
        if (Email.Length > 100)
        {
            Message = "Email is too long (max 100 chars).";
            return false;
        }
        return true;
    }

    private bool ValidatePasswords()
    {
        if (string.IsNullOrWhiteSpace(NewPassword))
        {
            Message = "New password cannot be empty.";
            return false;
        }
        if (NewPassword.Length < 6)
        {
            Message = "Password must be at least 6 characters.";
            return false;
        }
        if (NewPassword.Length > 50)
        {
            Message = "Password too long (max 50 chars).";
            return false;
        }
        if (NewPassword != ConfirmPassword)
        {
            Message = "Passwords do not match.";
            return false;
        }
        return true;
    }

    private void VerifyEmail()
    {
        Message = string.Empty;

        if (!ValidateEmailOnly())
        {
            ToastService.ShowError(Message);
            return;
        }

        EmailVerified = true;
        ToastService.ShowSuccess("Email verified. Please set a new password.");
    }

    private void ChangePassword()
    {
        Message = string.Empty;

        if (!ValidateEmailOnly())
        {
            ToastService.ShowError(Message);
            return;
        }

        if (!ValidatePasswords())
        {
            ToastService.ShowError(Message);
            return;
        }

        ToastService.ShowSuccess("Password reset successful! Please login with your new password.");
        NavigationManager.NavigateTo("/login");
    }
}
