@page "/admin/users"
@using GrapheneTrace.Client.Services
@using GrapheneTrace.Client.Models
@using GrapheneTrace.Core.DTOs.Admin
@using GrapheneTrace.Core.Enums
@using System.Net.Http.Headers
@using System.Net.Http.Json
@inject IDialogService DialogService
@inject HttpClient Http
@inject AuthService AuthService
@inject AppToastService ToastService

<PageTitle>Admin User Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="pa-6">
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-6">
        <div>
            <MudText Typo="Typo.h4" Class="fw-bold">Patient Management</MudText>
            <MudText Typo="Typo.subtitle2" Class="text-secondary">
                Manage patient accounts, assignments, and lifecycle operations.
            </MudText>
        </div>
        <MudStack Row="true" Spacing="2">
            <MudButton Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.PersonAdd" OnClick="OpenAddUserDialog" Disabled="@_loading">
                Add New Patient
            </MudButton>
            <MudButton Color="Color.Info" Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.MedicalServices" Href="/admin/clinicians">
                Manage Clinicians
            </MudButton>
        </MudStack>
    </MudStack>

    @if (_loading && _users.Count == 0)
    {
        <MudContainer Class="d-flex justify-center align-center" style="min-height: 400px;">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        </MudContainer>
    }
    else if (!string.IsNullOrEmpty(_loadError))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4">@_loadError</MudAlert>
    }
    else
    {
    <MudPaper Class="pa-4 mb-4 elevation-1">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
            <MudTextField @bind-Value="searchTerm" Placeholder="Search by name, email, or role" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Outlined.Search" Immediate="true" Class="flex-grow-1" />
            <MudSelect T="string" @bind-Value="statusFilter" Label="Status" Variant="Variant.Outlined" Dense="true">
                <MudSelectItem Value="@string.Empty">All Statuses</MudSelectItem>
                <MudSelectItem Value="@StatusActive">Active</MudSelectItem>
                <MudSelectItem Value="@StatusSuspended">Suspended</MudSelectItem>
            </MudSelect>
        </MudStack>
    </MudPaper>

    <MudPaper Class="pa-0 elevation-2">
        <MudDataGrid T="AdminUser" Items="@FilteredUsers"
                     Hover="true"
                     Dense="true"
                     Bordered="false"
                     RowClick="OnRowClick"
                     SelectedItem="@selectedUser"
                     Class="border-0">
            <Columns>
                <PropertyColumn T="AdminUser" TProperty="string" Property="@(u => u.Id)" Title="User ID" />
                <PropertyColumn T="AdminUser" TProperty="string" Property="@(u => u.FullName)" Title="Name" />
                <PropertyColumn T="AdminUser" TProperty="string" Property="@(u => u.Email)" Title="Email" />
                <TemplateColumn Title="Role">
                    <CellTemplate>
                        <MudChip T="string" Color="@RoleChipColor(context.Item.Role)" Size="Size.Small">
                            @context.Item.Role
                        </MudChip>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Status">
                    <CellTemplate>
                        <MudBadge Color="@StatusBadgeColor(context.Item.Status)">
                            @context.Item.Status
                        </MudBadge>
                    </CellTemplate>
                </TemplateColumn>
                <PropertyColumn T="AdminUser" TProperty="DateTime" Property="@(u => u.LastLogin)" Title="Last Login" Format="yyyy-MM-dd HH:mm" />
                <TemplateColumn Title="Assigned Clinician">
                    <CellTemplate>
                        <MudText Typo="Typo.caption">@DisplayAssignedClinician(context.Item)</MudText>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Actions">
                    <CellTemplate>
                        <MudStack Row="true" Spacing="1">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" OnClick="() => OpenEditUserDialog(context.Item)" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="() => DeleteUserAsync(context.Item)" />
                        </MudStack>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    </MudPaper>

    <MudGrid Class="mt-6">
        <MudItem xs="12" md="6">
            <MudCard Class="h-100 elevation-1">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Selected User Snapshot</MudText>
                </MudCardHeader>
                <MudCardContent>
                    @if (selectedUser is null)
                    {
                        <MudText Typo="Typo.caption" Class="text-secondary">Select a user from the table to view details.</MudText>
                    }
                    else
                    {
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.h6">@selectedUser.FullName</MudText>
                            <MudText Typo="Typo.subtitle2" Class="text-secondary">@selectedUser.Email</MudText>
                            <MudDivider Class="my-2" />
                            <MudChip T="string" Color="Color.Primary">@selectedUser.Role</MudChip>
                            <MudChip T="string" Color="@StatusBadgeColor(selectedUser.Status)">
                                @selectedUser.Status
                            </MudChip>
                            <MudText Typo="Typo.body2">Last login: @selectedUser.LastLogin.ToString("f")</MudText>
                            @if (selectedUser.Role == RolePatient)
                            {
                                <MudPaper Class="pa-3 border border-1 rounded-3">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.subtitle2" Class="fw-semibold">Patient Data Summary</MudText>
                                        <MudText Typo="Typo.body2">Assigned clinician: @DisplayAssignedClinician(selectedUser)</MudText>
                                        <MudText Typo="Typo.body2">Total pressure frames stored: @selectedUser.TotalFrames:N0</MudText>
                                        <MudText Typo="Typo.body2">Last data received: @selectedUser.LastDataReceived:g</MudText>
                                    </MudStack>
                                </MudPaper>
                            }
                        </MudStack>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" md="6">
            <MudCard Class="h-100 elevation-1">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Lifecycle Guidance</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Spacing="1">
                        <MudAlert Severity="Severity.Info" Dense="true" Elevation="0">
                            Use the Add User action to onboard patients and clinicians with minimal required details.
                        </MudAlert>
                        <MudAlert Severity="Severity.Info" Dense="true" Elevation="0">
                            Click any row to review an account. Use the edit action to adjust roles or suspend access.
                        </MudAlert>
                        <MudAlert Severity="Severity.Warning" Dense="true" Elevation="0">
                            Suspended users retain historical records but cannot sign in until reactivated.
                        </MudAlert>
                        <MudAlert Severity="Severity.Info" Dense="true" Elevation="0">
                            Ensure patients remain linked to an active clinician for governance accountability.
                        </MudAlert>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
    }
</MudContainer>

@code {
    private const string NotAssignedLabel = "Not Assigned";
    private const string RolePatient = "Patient";
    private const string RoleClinician = "Clinician";
    private const string StatusActive = "Active";
    private const string StatusSuspended = "Suspended";

    private bool _loading = true;
    private string? _loadError;
    private List<AdminUser> _users = new();
    private List<AdminUserDto> _clinicians = new(); // For assigning to patients
    private string searchTerm = string.Empty;
    private string roleFilter = string.Empty;
    private string statusFilter = string.Empty;
    private AdminUser? selectedUser;

    private IEnumerable<AdminUser> FilteredUsers => _users
        .Where(MatchesSearch)
        .Where(MatchesRole)
        .Where(MatchesStatus)
        .OrderByDescending(user => user.LastLogin);

    protected override async Task OnInitializedAsync()
    {
        await LoadUsersAsync();
    }

    private void EnsureAuthHeader()
    {
        if (!string.IsNullOrEmpty(AuthService.Token))
        {
            // Remove existing authorization header first
            Http.DefaultRequestHeaders.Remove("Authorization");
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", AuthService.Token);
            Console.WriteLine($"Auth header set: Bearer {AuthService.Token.Substring(0, Math.Min(20, AuthService.Token.Length))}...");
        }
        else
        {
            Console.WriteLine("Warning: No auth token available!");
        }
    }

    private async Task LoadUsersAsync()
    {
        _loading = true;
        _loadError = null;
        StateHasChanged();

        try
        {
            EnsureAuthHeader();

            var response = await Http.GetAsync("api/admin/users");
            if (response.IsSuccessStatusCode)
            {
                var userDtos = await response.Content.ReadFromJsonAsync<List<AdminUserDto>>();
                if (userDtos != null)
                {
                    // Filter only Patients
                    _users = userDtos
                        .Where(dto => dto.Role == UserRole.Patient)
                        .Select(dto => new AdminUser(
                            dto.Id.ToString(),
                            dto.FullName,
                            dto.Email,
                            dto.Role.ToString(),
                            dto.IsActive ? StatusActive : StatusSuspended,
                            dto.LastLoginAt ?? DateTime.MinValue,
                            dto.AssignedClinicianName ?? NotAssignedLabel,
                            0, // TotalFrames - would need separate API call
                            DateTime.MinValue // LastDataReceived - would need separate API call
                        )).ToList();

                    // Store clinicians for assignment dropdown
                    _clinicians = userDtos.Where(u => u.Role == UserRole.Clinician).ToList();
                }
            }
            else
            {
                _loadError = $"Failed to load users: {response.StatusCode}";
                ToastService?.ShowError(_loadError);
            }
        }
        catch (HttpRequestException httpEx)
        {
            _loadError = $"Cannot connect to API server. Please ensure the backend is running. Error: {httpEx.Message}";
            ToastService?.ShowError(_loadError);
        }
        catch (Exception ex)
        {
            _loadError = $"Error loading users: {ex.Message}";
            ToastService?.ShowError(_loadError);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private bool MatchesSearch(AdminUser user)
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            return true;
        }

        var term = searchTerm.Trim().ToLowerInvariant();
        return user.FullName.ToLowerInvariant().Contains(term)
            || user.Email.ToLowerInvariant().Contains(term)
            || user.Role.ToLowerInvariant().Contains(term)
            || user.Id.ToLowerInvariant().Contains(term);
    }

    private bool MatchesRole(AdminUser user)
    {
        // All users in list are patients, so always return true
        return true;
    }

    private bool MatchesStatus(AdminUser user)
    {
        if (string.IsNullOrWhiteSpace(statusFilter))
        {
            return true;
        }

        return user.Status.Equals(statusFilter, StringComparison.OrdinalIgnoreCase);
    }

    private void OnRowClick(DataGridRowClickEventArgs<AdminUser> args)
    {
        selectedUser = args.Item;
    }

    private async Task OpenAddUserDialog()
    {
        var model = new AdminUserFormModel
        {
            Role = RolePatient,
            Status = StatusActive
        };
        await ShowUserDialog("Add New User", model, isEdit: false);
    }

    private async Task OpenEditUserDialog(AdminUser user)
    {
        var model = new AdminUserFormModel
        {
            Id = user.Id,
            FullName = user.FullName,
            Email = user.Email,
            Role = user.Role,
            Status = user.Status,
            AssignedClinician = user.AssignedClinician == NotAssignedLabel ? string.Empty : user.AssignedClinician
        };

        await ShowUserDialog("Edit User", model, isEdit: true);
    }

    private async Task ShowUserDialog(string title, AdminUserFormModel model, bool isEdit)
    {
        var parameters = new DialogParameters
        {
            [nameof(UserDialog.FormModel)] = model,
            [nameof(UserDialog.IsEdit)] = isEdit,
            [nameof(UserDialog.AvailableClinicians)] = _clinicians
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            FullWidth = true,
            MaxWidth = MaxWidth.Small
        };

        var dialog = DialogService.Show<UserDialog>(title, parameters, options);
        var result = await dialog.Result;

        if (result.Canceled || result.Data == null || result.Data is not AdminUserFormModel formResult)
        {
            return;
        }

        if (isEdit)
        {
            await UpdateUserAsync(formResult);
        }
        else
        {
            await CreateUserAsync(formResult);
        }
    }

    private async Task CreateUserAsync(AdminUserFormModel formResult)
    {
        try
        {
            EnsureAuthHeader();

            // Validate required fields
            if (string.IsNullOrWhiteSpace(formResult.FullName))
            {
                ToastService?.ShowError("Full Name is required.");
                return;
            }

            if (string.IsNullOrWhiteSpace(formResult.Email))
            {
                ToastService?.ShowError("Email is required.");
                return;
            }

            if (string.IsNullOrWhiteSpace(formResult.Password))
            {
                ToastService?.ShowError("Password is required.");
                return;
            }

            var newUserDto = new NewUserDto
            {
                FullName = formResult.FullName.Trim(),
                Email = formResult.Email.Trim(),
                Password = formResult.Password,
                Role = UserRole.Patient, // Always create as Patient
                AssignedClinicianId = GetClinicianIdFromName(formResult.AssignedClinician)
            };

            Console.WriteLine($"Creating user: {newUserDto.Email}, Role: {newUserDto.Role}");
            Console.WriteLine($"Request URL: {Http.BaseAddress}api/admin/users");
            Console.WriteLine($"Auth Token Present: {!string.IsNullOrEmpty(AuthService.Token)}");
            
            var response = await Http.PostAsJsonAsync("api/admin/users", newUserDto);
            
            Console.WriteLine($"Response Status: {response.StatusCode}");
            Console.WriteLine($"Response Headers: {string.Join(", ", response.Headers.Select(h => $"{h.Key}={string.Join(",", h.Value)}"))}");
            
            if (response.IsSuccessStatusCode)
            {
                var createdDto = await response.Content.ReadFromJsonAsync<AdminUserDto>();
                if (createdDto != null)
                {
                    ToastService?.ShowSuccess("Patient created successfully!");
                    await LoadUsersAsync(); // Reload users
                    
                    // Select the newly created user
                    selectedUser = _users.FirstOrDefault(u => u.Id == createdDto.Id.ToString());
                }
            }
            else
            {
                var errorText = await response.Content.ReadAsStringAsync();
                var statusCode = response.StatusCode;
                
                if (statusCode == System.Net.HttpStatusCode.Conflict)
                {
                    ToastService?.ShowError("Email already exists. Please use a different email.");
                }
                else if (statusCode == System.Net.HttpStatusCode.Unauthorized)
                {
                    ToastService?.ShowError("Unauthorized. Please login again.");
                }
                else if (statusCode == System.Net.HttpStatusCode.Forbidden)
                {
                    ToastService?.ShowError("You don't have permission to create users.");
                }
                else if (statusCode == System.Net.HttpStatusCode.BadRequest)
                {
                    ToastService?.ShowError($"Invalid request: {errorText}");
                }
                else
                {
                    ToastService?.ShowError($"Failed to create patient (Status: {statusCode}): {errorText}");
                }
            }
        }
        catch (HttpRequestException httpEx)
        {
            ToastService?.ShowError($"Network error: Cannot connect to API server. Please ensure the backend is running on http://localhost:5200. Error: {httpEx.Message}");
        }
        catch (TaskCanceledException)
        {
            ToastService?.ShowError("Request timeout. The API server may be slow or not responding.");
        }
        catch (Exception ex)
        {
            ToastService?.ShowError($"Error creating patient: {ex.Message}");
        }
    }

    private async Task UpdateUserAsync(AdminUserFormModel formResult)
    {
        if (!Guid.TryParse(formResult.Id, out var userId))
        {
            ToastService?.ShowError("Invalid user ID");
            return;
        }

        try
        {
            EnsureAuthHeader();

            var updateUserDto = new UpdateUserDto
            {
                FullName = formResult.FullName,
                Email = formResult.Email,
                Role = UserRole.Patient, // Always keep as Patient
                IsActive = formResult.Status == StatusActive,
                AssignedClinicianId = GetClinicianIdFromName(formResult.AssignedClinician),
                Password = string.IsNullOrWhiteSpace(formResult.Password) ? null : formResult.Password
            };

            var response = await Http.PutAsJsonAsync($"api/admin/users/{userId}", updateUserDto);
            
            if (response.IsSuccessStatusCode)
            {
                var updatedDto = await response.Content.ReadFromJsonAsync<AdminUserDto>();
                if (updatedDto != null)
                {
                    ToastService?.ShowSuccess("User updated successfully!");
                    await LoadUsersAsync(); // Reload users
                    
                    // Select the updated user
                    selectedUser = _users.FirstOrDefault(u => u.Id == updatedDto.Id.ToString());
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                ToastService?.ShowError("User not found.");
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Conflict)
            {
                ToastService?.ShowError("Email already exists. Please use a different email.");
            }
            else
            {
                var errorText = await response.Content.ReadAsStringAsync();
                ToastService?.ShowError($"Failed to update user: {errorText}");
            }
        }
        catch (Exception ex)
        {
            ToastService?.ShowError($"Error updating user: {ex.Message}");
        }
    }

    private Guid? GetClinicianIdFromName(string? clinicianName)
    {
        if (string.IsNullOrWhiteSpace(clinicianName) || clinicianName == NotAssignedLabel)
        {
            return null;
        }

        var clinician = _clinicians.FirstOrDefault(c => c.FullName == clinicianName || c.FullName.Contains(clinicianName));
        return clinician?.Id;
    }

    private async Task DeleteUserAsync(AdminUser user)
    {
        if (!Guid.TryParse(user.Id, out var userId))
        {
            ToastService?.ShowError("Invalid user ID");
            return;
        }

        var confirmed = await DialogService.ShowMessageBox(
            "Delete User",
            $"Are you sure you want to delete user '{user.FullName}' ({user.Email})?",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirmed != true)
        {
            return;
        }

        try
        {
            EnsureAuthHeader();

            var response = await Http.DeleteAsync($"api/admin/users/{userId}");
            
            if (response.IsSuccessStatusCode)
            {
                ToastService?.ShowSuccess("User deleted successfully!");
                await LoadUsersAsync(); // Reload users
                selectedUser = null;
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                ToastService?.ShowError("User not found.");
            }
            else
            {
                var errorText = await response.Content.ReadAsStringAsync();
                ToastService?.ShowError($"Failed to delete user: {errorText}");
            }
        }
        catch (Exception ex)
        {
            ToastService?.ShowError($"Error deleting user: {ex.Message}");
        }
    }

    private Color RoleChipColor(string role) => string.Equals(role, RoleClinician, StringComparison.OrdinalIgnoreCase) ? Color.Info : Color.Primary;

    private Color StatusBadgeColor(string status) => string.Equals(status, StatusActive, StringComparison.OrdinalIgnoreCase) ? Color.Success : Color.Error;

    private string DisplayAssignedClinician(AdminUser user) => string.Equals(user.Role, RolePatient, StringComparison.OrdinalIgnoreCase) && !string.IsNullOrWhiteSpace(user.AssignedClinician)
        ? user.AssignedClinician
        : NotAssignedLabel;

    private static string NormalizeAssignedClinician(AdminUserFormModel model) => string.Equals(model.Role, RolePatient, StringComparison.OrdinalIgnoreCase)
        ? (string.IsNullOrWhiteSpace(model.AssignedClinician) ? NotAssignedLabel : model.AssignedClinician)
        : NotAssignedLabel;
}
