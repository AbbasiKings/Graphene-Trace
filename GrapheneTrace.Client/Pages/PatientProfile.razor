@page "/patient/profile"
@using GrapheneTrace.Client.Models
@using GrapheneTrace.Core.DTOs.Patient
@using GrapheneTrace.Client.Services
@using MudBlazor
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components
@using GrapheneTrace.Client.Components
@inject HttpClient Http
@inject AuthService AuthService
@inject AppToastService ToastService
@inject IJSRuntime JSRuntime
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.False" Class="pa-6 patient-profile">
    @if (_loading)
    {
        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Style="min-height: 400px;">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        </MudStack>
    }
    else if (!string.IsNullOrEmpty(_loadError))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4">@_loadError</MudAlert>
    }
    else
    {
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-6">
        <div>
            <MudText Typo="Typo.h4" Class="fw-bold">Profile &amp; Settings</MudText>
            <MudText Typo="Typo.subtitle2" Class="text-secondary">
                Keep your information up to date and choose how you receive important alerts.
            </MudText>
        </div>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save" OnClick="SaveChangesAsync">
            Save Changes
        </MudButton>
    </MudStack>

    <MudGrid Spacing="2">
        <MudItem xs="12" md="6">
            <MudCard Class="elevation-2">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Personal Information</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudGrid Spacing="2">
                        <MudItem xs="12" md="6">
                            <MudTextField Label="Full name" Variant="Variant.Outlined" @bind-Value="fullName" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudDatePicker @bind-Date="_dateOfBirth"
                                           Label="Date of birth"
                                           Variant="Variant.Outlined"
                                           DateFormat="yyyy-MM-dd"
                                           MaxDate="@DateTime.Today" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField Label="Email" Variant="Variant.Outlined" @bind-Value="email" Disabled="true" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField Label="Phone number" Variant="Variant.Outlined" @bind-Value="phoneNumber" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField Label="Primary address"
                                          Variant="Variant.Outlined"
                                          Lines="2"
                                          @bind-Value="primaryAddress" />
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" md="6">
            <MudCard Class="elevation-2">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Assigned Clinician</MudText>
                </MudCardHeader>
                <MudCardContent>
                    @if (_profileData?.AssignedClinician == null)
                    {
                        <MudStack Spacing="2" AlignItems="AlignItems.Center" Justify="Justify.Center" Style="min-height: 200px;">
                            <MudIcon Icon="@Icons.Material.Filled.PersonOff" Size="Size.Large" Color="Color.Secondary" Style="opacity: 0.5;" />
                            <MudText Typo="Typo.h6" Class="text-secondary">No Clinician Assigned</MudText>
                            <MudText Typo="Typo.body2" Class="text-secondary" Style="text-align: center;">
                                You don't have an assigned clinician yet. Please contact your administrator.
                            </MudText>
                        </MudStack>
                    }
                    else
                    {
                        <MudStack Spacing="1">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudAvatar Size="Size.Large" Color="Color.Primary">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" />
                                </MudAvatar>
                                <MudStack>
                                    <MudText Typo="Typo.subtitle1" Class="fw-semibold">@(_profileData.AssignedClinician.FullName)</MudText>
                                    <MudText Typo="Typo.caption" Class="text-secondary">
                                        @(string.IsNullOrEmpty(_profileData.AssignedClinician.Specialization) 
                                            ? "Clinician" 
                                            : _profileData.AssignedClinician.Specialization)
                                        @(string.IsNullOrEmpty(_profileData.AssignedClinician.ClinicName) 
                                            ? "" 
                                            : $" Â· {_profileData.AssignedClinician.ClinicName}")
                                    </MudText>
                                </MudStack>
                            </MudStack>
                            <MudDivider />
                            <MudText Typo="Typo.caption" Class="text-secondary">Contact options</MudText>
                            <MudList T="string" Dense="true">
                                <MudListItem T="string">
                                    <MudIcon Icon="@Icons.Material.Filled.Email" Class="me-2" />
                                    @_profileData.AssignedClinician.Email
                                </MudListItem>
                                @if (!string.IsNullOrEmpty(_profileData.AssignedClinician.PhoneNumber))
                                {
                                    <MudListItem T="string">
                                        <MudIcon Icon="@Icons.Material.Filled.Phone" Class="me-2" />
                                        @_profileData.AssignedClinician.PhoneNumber
                                    </MudListItem>
                                }
                            </MudList>
                            <MudButton Variant="Variant.Text" 
                                       Color="Color.Primary" 
                                       StartIcon="@Icons.Material.Filled.CalendarToday"
                                       OnClick="ScheduleAppointment">
                                Schedule new appointment
                            </MudButton>
                        </MudStack>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <MudCard Class="elevation-1 mt-4">
        <MudCardHeader>
            <MudText Typo="Typo.h6">Notification Preferences</MudText>
        </MudCardHeader>
        <MudCardContent>
            <MudGrid Spacing="2">
                @foreach (var preference in NotificationPreferences)
                {
                    <MudItem xs="12" md="4">
                        <MudPaper Class="pa-4 preference-card" Elevation="1">
                            <MudStack Spacing="1">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@Icons.Material.Filled.Notifications" Color="Color.Primary" />
                                    <MudText Typo="Typo.subtitle2" Class="fw-semibold">@preference.Label</MudText>
                                </MudStack>
                                <MudText Typo="Typo.caption" Class="text-secondary">@preference.Description</MudText>
                                <MudSwitch T="bool" @bind-Value="preference.Enabled" Color="Color.Primary" />
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                }
            </MudGrid>
        </MudCardContent>
    </MudCard>

    <MudCard Class="elevation-1 mt-4">
        <MudCardHeader>
            <MudText Typo="Typo.h6">Security</MudText>
        </MudCardHeader>
        <MudCardContent>
            <MudStack Spacing="1">
                <MudText Typo="Typo.caption" Class="text-secondary">
                    Keep your account secure by using a strong password and enabling multi-factor authentication.
                </MudText>
                <MudStack Row="true" Spacing="1">
                    <MudButton Variant="Variant.Outlined" 
                               StartIcon="@Icons.Material.Filled.LockReset" 
                               Color="Color.Primary"
                               OnClick="OpenChangePasswordDialog">
                        Change password
                    </MudButton>
                    <MudButton Variant="Variant.Text" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Fingerprint">
                        Enable MFA
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudCardContent>
    </MudCard>
    }
</MudContainer>

@code {
    private bool _loading = true;
    private string? _loadError;
    private PatientProfileDto? _profileData;
    private string fullName = string.Empty;
    private DateTime? _dateOfBirth;
    private string email = string.Empty;
    private string phoneNumber = string.Empty;
    private string primaryAddress = string.Empty;

    private readonly List<PatientNotificationPreference> NotificationPreferences = new()
    {
        new PatientNotificationPreference("Critical alerts", "Push and email when high pressure is detected.") { Enabled = true },
        new PatientNotificationPreference("Clinician replies", "Instant notification when your clinician responds.") { Enabled = true },
        new PatientNotificationPreference("Daily summary", "Evening recap of daily pressure and activity trends.") { Enabled = false }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadProfileAsync();
        await LoadNotificationPreferencesAsync();
    }

    private async Task LoadProfileAsync()
    {
        _loading = true;
        _loadError = null;

        try
        {
            EnsureAuthHeader();
            _profileData = await Http.GetFromJsonAsync<PatientProfileDto>("api/patient/profile");

            if (_profileData != null)
            {
                fullName = _profileData.FullName;
                email = _profileData.Email;
                _dateOfBirth = _profileData.DateOfBirth;
                phoneNumber = _profileData.PhoneNumber ?? string.Empty;
                primaryAddress = _profileData.Address ?? string.Empty;
            }
        }
        catch (Exception ex)
        {
            _loadError = $"Failed to load profile: {ex.Message}";
            ToastService?.ShowError(_loadError);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private void EnsureAuthHeader()
    {
        if (AuthService?.Token != null && !Http.DefaultRequestHeaders.Contains("Authorization"))
        {
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", AuthService.Token);
        }
    }

    private async Task SaveChangesAsync()
    {
        try
        {
            EnsureAuthHeader();

            var updateDto = new UpdatePatientProfileDto
            {
                FullName = fullName,
                DateOfBirth = _dateOfBirth,
                PhoneNumber = string.IsNullOrWhiteSpace(phoneNumber) ? null : phoneNumber,
                Address = string.IsNullOrWhiteSpace(primaryAddress) ? null : primaryAddress
            };

            var response = await Http.PutAsJsonAsync("api/patient/profile", updateDto);

            if (response.IsSuccessStatusCode)
            {
                _profileData = await response.Content.ReadFromJsonAsync<PatientProfileDto>();
                
                // Save notification preferences
                await SaveNotificationPreferencesAsync();
                
                ToastService?.ShowSuccess("Profile updated successfully!");
                
                // Reload profile data to show updated values
                await LoadProfileAsync();
            }
            else
            {
                var errorText = await response.Content.ReadAsStringAsync();
                ToastService?.ShowError($"Failed to save profile: {errorText}");
            }
        }
        catch (Exception ex)
        {
            ToastService?.ShowError($"Failed to save profile: {ex.Message}");
        }
    }

    private async Task SaveNotificationPreferencesAsync()
    {
        try
        {
            // Save notification preferences to localStorage
            var prefsJson = System.Text.Json.JsonSerializer.Serialize(NotificationPreferences);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "notification_preferences", prefsJson);
        }
        catch
        {
            // Ignore errors
        }
    }

    private async Task LoadNotificationPreferencesAsync()
    {
        try
        {
            var prefsJson = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "notification_preferences");
            if (!string.IsNullOrWhiteSpace(prefsJson))
            {
                var savedPrefs = System.Text.Json.JsonSerializer.Deserialize<List<PatientNotificationPreference>>(prefsJson);
                if (savedPrefs != null && savedPrefs.Count == NotificationPreferences.Count)
                {
                    for (int i = 0; i < NotificationPreferences.Count; i++)
                    {
                        NotificationPreferences[i].Enabled = savedPrefs[i].Enabled;
                    }
                }
            }
        }
        catch
        {
            // Ignore errors - use defaults
        }
    }

    private async Task ScheduleAppointment()
    {
        ToastService?.ShowInfo("Appointment scheduling feature coming soon! Please contact your clinician directly via email or phone.");
    }

    private async Task OpenChangePasswordDialog()
    {
        var parameters = new DialogParameters
        {
            [nameof(ChangePasswordDialog.model)] = new ChangePasswordModel()
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = DialogService.Show<ChangePasswordDialog>("Change Password", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is ChangePasswordModel model)
        {
            await ChangePasswordAsync(model);
        }
    }

    private async Task ChangePasswordAsync(ChangePasswordModel model)
    {
        try
        {
            EnsureAuthHeader();

            var request = new ChangePasswordDto
            {
                CurrentPassword = model.CurrentPassword,
                NewPassword = model.NewPassword
            };

            var response = await Http.PutAsJsonAsync("api/patient/change-password", request);
            
            Console.WriteLine($"Password change response status: {response.StatusCode}");

            if (response.IsSuccessStatusCode)
            {
                ToastService?.ShowSuccess("Password changed successfully!");
            }
            else
            {
                var errorText = await response.Content.ReadAsStringAsync();
                var statusCode = response.StatusCode;
                
                // Try to parse error message from response
                string errorMessage = errorText;
                try
                {
                    if (errorText.StartsWith("{") || errorText.StartsWith("["))
                    {
                        var errorObj = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement>(errorText);
                        if (errorObj.TryGetProperty("message", out var messageProp))
                        {
                            errorMessage = messageProp.GetString() ?? errorText;
                        }
                        else if (errorObj.TryGetProperty("error", out var errorProp))
                        {
                            errorMessage = errorProp.GetString() ?? errorText;
                        }
                    }
                }
                catch
                {
                    // Use raw error text if parsing fails
                }
                
                if (statusCode == System.Net.HttpStatusCode.BadRequest)
                {
                    ToastService?.ShowError(errorMessage);
                }
                else if (statusCode == System.Net.HttpStatusCode.Unauthorized)
                {
                    ToastService?.ShowError("Unauthorized. Please login again.");
                }
                else
                {
                    ToastService?.ShowError($"Failed to change password: {errorMessage}");
                }
            }
        }
        catch (HttpRequestException httpEx)
        {
            ToastService?.ShowError($"Network error: {httpEx.Message}");
        }
        catch (Exception ex)
        {
            ToastService?.ShowError($"Failed to change password: {ex.Message}");
        }
    }
}

