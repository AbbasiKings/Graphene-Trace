@page "/clinician/dashboard"
@using GrapheneTrace.Client.Services
@using GrapheneTrace.Client.Models
@using GrapheneTrace.Core.DTOs.Clinician
@using GrapheneTrace.Core.Enums
@inject AuthService AuthService
@inject HttpClient Http
@inject AppToastService ToastService

<PageTitle>Clinician Dashboard</PageTitle>

@if (_loading)
{
    <div class="d-flex justify-center my-8">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
    </div>
}
else if (!string.IsNullOrEmpty(_loadError))
{
    <MudAlert Severity="Severity.Error">@_loadError</MudAlert>
}
else
{
    <MudContainer MaxWidth="MaxWidth.False" Class="pa-6">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-6">
            <div>
                <MudText Typo="Typo.h4" Class="fw-bold">Triage Overview</MudText>
                <MudText Typo="Typo.subtitle2" Class="text-secondary">
                    Monitor urgent alerts, high-risk patients, and system health in real time.
                </MudText>
            </div>
            <MudChip T="string" Color="Color.Primary">
                @AuthService.UserName (@AuthService.UserEmail)
            </MudChip>
        </MudStack>

        <MudGrid Class="mb-6">
            @foreach (var card in AlertCards)
            {
                <MudItem xs="12" md="6" lg="3">
                    <MudCard Class="elevation-2 h-100">
                        <MudCardContent>
                            <MudStack Spacing="1">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudText Typo="Typo.subtitle2" Class="text-secondary">@card.Title</MudText>
                                    <MudIcon Icon="@card.Icon" Color="@card.IconColor" />
                                </MudStack>
                                <MudText Typo="Typo.h4" Class="fw-semibold">@card.Value</MudText>
                                <MudText Typo="Typo.caption" Color="@card.TrendColor">@card.Trend</MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>

        <MudGrid Spacing="2" Class="mb-6">
            <MudItem xs="12" lg="7">
                <MudCard Class="elevation-2 h-100">
                    <MudCardHeader>
                        <MudText Typo="Typo.h6">High-Risk Patients</MudText>
                        <MudText Typo="Typo.caption" Class="text-secondary">
                            Prioritised by last alert severity and recency.
                        </MudText>
                    </MudCardHeader>
                    <MudCardContent Class="pt-0">
                        @if (_triagePatients.Count == 0)
                        {
                            <MudText Typo="Typo.body2" Class="text-secondary">No patients assigned yet.</MudText>
                        }
                        else
                        {
                            <MudTable T="TriagePatientDto" Items="@_triagePatients" Dense="true" Hover="true">
                                <HeaderContent>
                                    <MudTh>Patient</MudTh>
                                    <MudTh>Risk</MudTh>
                                    <MudTh>New Alerts</MudTh>
                                    <MudTh>New Comments</MudTh>
                                    <MudTh>Last Data</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Patient">
                                        <MudText Typo="Typo.body2" Class="fw-semibold">@context.PatientName</MudText>
                                        <MudText Typo="Typo.caption" Class="text-secondary">@context.PatientId.ToString("N")[..8]</MudText>
                                    </MudTd>
                                    <MudTd DataLabel="Risk">
                                        <MudChip T="string" Color="@GetRiskColor(context.HighestRisk)" Size="Size.Small">@context.HighestRisk</MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="New Alerts">
                                        <MudBadge Content="@context.NewAlertCount" Color="Color.Error" Overlap="true">
                                            <MudText Typo="Typo.body2">@context.NewAlertCount</MudText>
                                        </MudBadge>
                                    </MudTd>
                                    <MudTd DataLabel="New Comments">
                                        <MudBadge Content="@context.NewCommentCount" Color="Color.Info" Overlap="true">
                                            <MudText Typo="Typo.body2">@context.NewCommentCount</MudText>
                                        </MudBadge>
                                    </MudTd>
                                    <MudTd DataLabel="Last Data">
                                        <MudText Typo="Typo.caption" Class="text-secondary">
                                            @(context.LastDataReceived?.ToLocalTime().ToString("MMM d · HH:mm") ?? "No data")
                                        </MudText>
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        <MudItem xs="12" lg="5">
            <MudCard Class="elevation-2 h-100">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">System Status</MudText>
                    <MudText Typo="Typo.caption" Class="text-secondary">
                        Live ingest & notification indicators.
                    </MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudList T="string" Dense="true">
                        <MudListItem>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.CloudDone" Color="Color.Success" />
                                <MudText>Sensor ingest pipeline healthy (last packet 4m ago)</MudText>
                            </MudStack>
                        </MudListItem>
                        <MudListItem>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.NotificationsActive" Color="Color.Warning" />
                                <MudText>1 alert queue awaiting clinician acknowledgement</MudText>
                            </MudStack>
                        </MudListItem>
                        <MudListItem>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Sync" Color="Color.Info" />
                                <MudText>Analytics refresh completed 12 minutes ago</MudText>
                            </MudStack>
                        </MudListItem>
                        <MudListItem>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Storage" Color="Color.Primary" />
                                <MudText>Timeseries storage operating at 63% of throughput budget</MudText>
                            </MudStack>
                        </MudListItem>
                    </MudList>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <MudCard Class="elevation-2">
        <MudCardHeader>
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                <MudStack>
                    <MudText Typo="Typo.h6">Recent Workflow Activity</MudText>
                    <MudText Typo="Typo.caption" Class="text-secondary">Events across triage, investigation, and communication workstreams.</MudText>
                </MudStack>
                <MudChip T="string" Color="Color.Info">Last 12 hours</MudChip>
            </MudStack>
        </MudCardHeader>
        <MudCardContent Class="pt-0">
            <MudTimeline>
                @foreach (var entry in TimelineEntries)
                {
                    <MudTimelineItem Color="@entry.Color" Icon="@Icons.Material.Filled.ArrowRightAlt">
                        <MudText Typo="Typo.body2" Class="fw-semibold">@entry.Timestamp.ToString("HH:mm")</MudText>
                        <MudText Typo="Typo.body2">@entry.Label</MudText>
                    </MudTimelineItem>
                }
            </MudTimeline>
        </MudCardContent>
    </MudCard>
    </MudContainer>
}

@code {
    private bool _loading = true;
    private string? _loadError;
    private List<TriagePatientDto> _triagePatients = new();
    private List<ClinicianAlertCard> AlertCards { get; set; } = new();
    private IReadOnlyList<TimelineMarker> TimelineEntries { get; } = new[]
    {
        new TimelineMarker(DateTime.Now.AddMinutes(-8), "Reviewed patient alert and initiated outreach", Color.Warning),
        new TimelineMarker(DateTime.Now.AddMinutes(-21), "Responded to patient comment", Color.Info),
        new TimelineMarker(DateTime.Now.AddMinutes(-44), "AI recalculated risk tiers", Color.Success),
        new TimelineMarker(DateTime.Now.AddHours(-2), "Downloaded comparative report", Color.Secondary),
        new TimelineMarker(DateTime.Now.AddHours(-5), "Resolved alert after follow-up", Color.Success)
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadTriageDataAsync();
    }

    private async Task LoadTriageDataAsync()
    {
        try
        {
            _loading = true;
            _loadError = null;
            StateHasChanged();

            _triagePatients = (await Http.GetFromJsonAsync<List<TriagePatientDto>>("api/clinician/triage")) ?? new();

            // Calculate summary metrics from triage data
            var totalNewAlerts = _triagePatients.Sum(p => p.NewAlertCount);
            var totalNewComments = _triagePatients.Sum(p => p.NewCommentCount);
            var totalPatients = _triagePatients.Count;
            var highRiskCount = _triagePatients.Count(p => p.HighestRisk >= RiskLevel.High);

            AlertCards = new List<ClinicianAlertCard>
            {
                new ClinicianAlertCard("New High-Pressure Alerts", totalNewAlerts.ToString(), $"{highRiskCount} high-risk patients", Color.Warning, Icons.Material.Filled.WarningAmber, Color.Warning),
                new ClinicianAlertCard("Pending Patient Comments", totalNewComments.ToString(), "Awaiting clinician reply", Color.Info, Icons.Material.Filled.MarkUnreadChatAlt, Color.Info),
                new ClinicianAlertCard("Patients Monitored", totalPatients.ToString(), "Assigned to you", Color.Success, Icons.Material.Filled.Groups, Color.Primary),
                new ClinicianAlertCard("High-Risk Patients", highRiskCount.ToString(), "Require immediate attention", Color.Error, Icons.Material.Filled.AutoAwesome, Color.Error)
            };
        }
        catch (Exception ex)
        {
            _loadError = $"Unable to load triage data: {ex.Message}";
            ToastService?.ShowError(_loadError);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private static Color GetRiskColor(RiskLevel risk) => risk switch
    {
        RiskLevel.Critical => Color.Error,
        RiskLevel.High => Color.Warning,
        RiskLevel.Medium => Color.Info,
        _ => Color.Success
    };
}

