@page "/clinician/alerts"
@using GrapheneTrace.Client.Models
@using GrapheneTrace.Client.Services
@using GrapheneTrace.Core.DTOs.Clinician
@using GrapheneTrace.Core.DTOs.Patient
@using GrapheneTrace.Core.Enums
@using MudBlazor
@using System.Net.Http.Headers
@using System.Threading
@inject HttpClient Http
@inject AppToastService ToastService
@inject AuthService AuthService

<PageTitle>Alerts &amp; Flagged Events</PageTitle>

@if (_loading)
{
    <MudContainer MaxWidth="MaxWidth.False" Class="pa-6">
        <div class="d-flex flex-column align-center justify-center" style="min-height: 400px;">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
            <MudText Typo="Typo.body2" Class="mt-4 text-secondary">Loading alerts and comments...</MudText>
            <MudButton Variant="Variant.Text" 
                       Color="Color.Secondary" 
                       Size="Size.Small"
                       Class="mt-4"
                       OnClick="CancelLoading">
                Cancel
            </MudButton>
            <MudButton Variant="Variant.Outlined" 
                       Color="Color.Primary" 
                       Size="Size.Small"
                       Class="mt-4 ms-2"
                       OnClick="async () => await LoadAlertsAsync()">
                Retry
            </MudButton>
        </div>
    </MudContainer>
}
else if (!string.IsNullOrEmpty(_loadError))
{
    <MudContainer MaxWidth="MaxWidth.False" Class="pa-6">
        <MudAlert Severity="Severity.Error" Class="mb-4">@_loadError</MudAlert>
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   StartIcon="@Icons.Material.Filled.Refresh"
                   OnClick="async () => await LoadAlertsAsync()">
            Retry
        </MudButton>
    </MudContainer>
}
else
{
    <MudContainer MaxWidth="MaxWidth.False" Class="pa-6">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-6">
            <div>
                <MudText Typo="Typo.h4" Class="fw-bold">Alerts &amp; Flagged Events</MudText>
                <MudText Typo="Typo.subtitle2" Class="text-secondary">
                    Review automated alerts and patient comments, update statuses, and jump into detailed analysis.
                </MudText>
            </div>
            <MudChip T="string" Color="Color.Warning">New: @NewEventsCount</MudChip>
        </MudStack>

    <MudPaper Class="pa-4 mb-4 elevation-1">
        <MudGrid Spacing="2">
            <MudItem xs="12" md="3">
                <MudSelect T="AlertStatus?" 
                           Value="@_statusFilter" 
                           ValueChanged="@((AlertStatus? val) => { _statusFilter = val; _currentPage = 0; })"
                           Label="Status" 
                           Variant="Variant.Outlined">
                    <MudSelectItem T="AlertStatus?" Value="@((AlertStatus?)null)">All statuses</MudSelectItem>
                    <MudSelectItem T="AlertStatus?" Value="@AlertStatus.New">New</MudSelectItem>
                    <MudSelectItem T="AlertStatus?" Value="@AlertStatus.InReview">In Review</MudSelectItem>
                    <MudSelectItem T="AlertStatus?" Value="@AlertStatus.Resolved">Resolved</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudSelect T="string" 
                           Value="@_typeFilter" 
                           ValueChanged="@((string val) => { _typeFilter = val ?? string.Empty; _currentPage = 0; })"
                           Label="Event type" 
                           Variant="Variant.Outlined">
                    <MudSelectItem Value="@string.Empty">All types</MudSelectItem>
                    <MudSelectItem Value="@("Alert")">High Pressure Alert</MudSelectItem>
                    <MudSelectItem Value="@("Comment")">Patient Comment</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudSelect T="RiskLevel?" 
                           Value="@_severityFilter" 
                           ValueChanged="@((RiskLevel? val) => { _severityFilter = val; _currentPage = 0; })"
                           Label="Severity" 
                           Variant="Variant.Outlined">
                    <MudSelectItem T="RiskLevel?" Value="@((RiskLevel?)null)">Any severity</MudSelectItem>
                    <MudSelectItem T="RiskLevel?" Value="@RiskLevel.Critical">Critical</MudSelectItem>
                    <MudSelectItem T="RiskLevel?" Value="@RiskLevel.High">High</MudSelectItem>
                    <MudSelectItem T="RiskLevel?" Value="@RiskLevel.Medium">Moderate</MudSelectItem>
                    <MudSelectItem T="RiskLevel?" Value="@RiskLevel.Low">Low</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudTextField Value="@_searchTerm"
                              ValueChanged="@((string val) => { _searchTerm = val ?? string.Empty; _currentPage = 0; })"
                              Variant="Variant.Outlined"
                              Placeholder="Search patient or summary"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Outlined.Search"
                              Immediate="true" />
            </MudItem>
        </MudGrid>
    </MudPaper>

        <MudPaper Class="pa-0 elevation-2">
            @if (_allEvents == null || _allEvents.Count == 0)
            {
                <MudText Typo="Typo.body2" Class="pa-4 text-secondary">No alerts or comments found.</MudText>
            }
            else
            {
                <MudTable T="AlertEventDto" 
                          Items="@PagedEvents" 
                          Hover="true" 
                          Dense="true" 
                          Loading="@_loading">
                    <HeaderContent>
                        <MudTh>Timestamp</MudTh>
                        <MudTh>Patient</MudTh>
                        <MudTh>Type</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>Severity</MudTh>
                        <MudTh>Summary</MudTh>
                        <MudTh></MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Timestamp">@context.Timestamp.ToLocalTime().ToString("g")</MudTd>
                        <MudTd DataLabel="Patient">
                            <MudText Typo="Typo.body2" Class="fw-semibold">@context.PatientName</MudText>
                            <MudText Typo="Typo.caption" Class="text-secondary">@context.PatientId.ToString("N")[..8]</MudText>
                        </MudTd>
                        <MudTd DataLabel="Type">
                            <MudChip T="string" Size="Size.Small" Color="@EventTypeColor(context.EventType)">@context.EventType</MudChip>
                        </MudTd>
                        <MudTd DataLabel="Status">
                            @if (context.IsAlert)
                            {
                                <MudSelect T="AlertStatus"
                                           Dense="true"
                                           Value="@context.Status"
                                           ValueChanged="@(async (AlertStatus status) => await UpdateAlertStatus(context.AlertId, status))"
                                           Variant="Variant.Outlined">
                                    <MudSelectItem T="AlertStatus" Value="@AlertStatus.New">New</MudSelectItem>
                                    <MudSelectItem T="AlertStatus" Value="@AlertStatus.InReview">In Review</MudSelectItem>
                                    <MudSelectItem T="AlertStatus" Value="@AlertStatus.Resolved">Resolved</MudSelectItem>
                                </MudSelect>
                            }
                            else
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Info">Comment</MudChip>
                            }
                        </MudTd>
                        <MudTd DataLabel="Severity">
                            <MudChip T="string" Size="Size.Small" Color="@GetRiskColor(context.RiskLevel)">@context.RiskLevel</MudChip>
                        </MudTd>
                        <MudTd DataLabel="Summary">
                            <MudText Typo="Typo.body2">@context.Summary</MudText>
                        </MudTd>
                        <MudTd DataLabel="Actions" Class="text-end">
                            <MudButton Variant="Variant.Outlined"
                                       Color="Color.Primary"
                                       Size="Size.Small"
                                       Href="@($"/clinician/patient-analysis?patientId={context.PatientId}")">
                                View Analysis
                            </MudButton>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
                
                @if (TotalPages > 1)
                {
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="pa-4">
                        <MudText Typo="Typo.body2" Class="text-secondary">
                            Showing @((_currentPage * 10) + 1) to @(Math.Min((_currentPage + 1) * 10, FilteredEvents.Count)) of @FilteredEvents.Count entries
                        </MudText>
                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                            <MudButton Variant="Variant.Text" 
                                       Color="Color.Primary" 
                                       StartIcon="@Icons.Material.Filled.ChevronLeft"
                                       Disabled="@(_currentPage == 0)"
                                       OnClick="@(() => { _currentPage = Math.Max(0, _currentPage - 1); StateHasChanged(); })">
                                Previous
                            </MudButton>
                            <MudText Typo="Typo.body2">
                                Page @(_currentPage + 1) of @TotalPages
                            </MudText>
                            <MudButton Variant="Variant.Text" 
                                       Color="Color.Primary" 
                                       EndIcon="@Icons.Material.Filled.ChevronRight"
                                       Disabled="@(_currentPage >= TotalPages - 1)"
                                       OnClick="@(() => { _currentPage = Math.Min(TotalPages - 1, _currentPage + 1); StateHasChanged(); })">
                                Next
                            </MudButton>
                        </MudStack>
                    </MudStack>
                }
            }
        </MudPaper>
    </MudContainer>
}

@code {
    private bool _loading = true;
    private string? _loadError;
    private List<AlertEventDto> _allEvents = new();
    private AlertStatus? _statusFilter;
    private string _typeFilter = string.Empty;
    private RiskLevel? _severityFilter;
    private string _searchTerm = string.Empty;
    private CancellationTokenSource? _cancellationTokenSource;
    private int _currentPage = 0;

    private int NewEventsCount => _allEvents?.Count(e => e.IsAlert && e.Status == AlertStatus.New) ?? 0;

    private List<AlertEventDto> FilteredEvents
    {
        get
        {
            if (_allEvents == null || _allEvents.Count == 0)
                return new List<AlertEventDto>();

            return _allEvents
                .Where(MatchesStatus)
                .Where(MatchesType)
                .Where(MatchesSeverity)
                .Where(MatchesSearch)
                .OrderByDescending(e => e.Timestamp)
                .ToList();
        }
    }

    private List<AlertEventDto> PagedEvents
    {
        get
        {
            var filtered = FilteredEvents;
            var skip = _currentPage * 10;
            return filtered.Skip(skip).Take(10).ToList();
        }
    }

    private int TotalPages => (int)Math.Ceiling(FilteredEvents.Count / 10.0);

    protected override async Task OnInitializedAsync()
    {
        // Start loading but don't block - page will render immediately
        _ = LoadAlertsAsync();
    }

    private void EnsureAuthHeader()
    {
        if (!string.IsNullOrEmpty(AuthService.Token))
        {
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", AuthService.Token);
        }
    }

    private async Task LoadAlertsAsync()
    {
        // Cancel any existing operation
        _cancellationTokenSource?.Cancel();
        _cancellationTokenSource?.Dispose();
        
        _loading = true;
        _loadError = null;
        _allEvents = new List<AlertEventDto>();
        
        try
        {
            StateHasChanged();
            
            // Create new cancellation token with 2 second timeout (very aggressive)
            _cancellationTokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(2));
            var cts = _cancellationTokenSource;
            
            EnsureAuthHeader();

            // Get all assigned patients with timeout
            List<TriagePatientDto> patients = new();
            try
            {
                var response = await Http.GetAsync("api/clinician/triage", cts.Token);
                if (response.IsSuccessStatusCode)
                {
                    patients = await response.Content.ReadFromJsonAsync<List<TriagePatientDto>>(cts.Token) ?? new();
                }
                else
                {
                    _loadError = $"Failed to load patient list: {response.StatusCode}";
                    ToastService?.ShowError(_loadError);
                }
            }
            catch (HttpRequestException httpEx)
            {
                _loadError = $"Cannot connect to API server. Please ensure the backend is running on http://localhost:5200. Error: {httpEx.Message}";
                ToastService?.ShowError(_loadError);
            }
            catch (TaskCanceledException)
            {
                if (cts.IsCancellationRequested)
                {
                    _loadError = "Request cancelled or timed out. Please try again.";
                    ToastService?.ShowError(_loadError);
                }
            }
            catch (Exception ex)
            {
                _loadError = $"Error loading patient list: {ex.Message}";
                ToastService?.ShowError(_loadError);
            }

            // For each patient, get their details (alerts + comments) with timeout
            // Limit to first 10 patients to get enough data for pagination
            var patientsToProcess = patients.Take(10).ToList();
            
            // Process patients in parallel with timeout
            var tasks = patientsToProcess.Select(async patient =>
            {
                // Check if cancelled
                if (cts.IsCancellationRequested)
                {
                    return;
                }
                
                try
                {
                    EnsureAuthHeader();
                    // Use same cancellation token for all requests
                    var response = await Http.GetAsync($"api/clinician/patient/{patient.PatientId}", cts.Token);
                    
                    if (response.IsSuccessStatusCode)
                    {
                        var details = await response.Content.ReadFromJsonAsync<PatientDetailDto>(cts.Token);
                        if (details != null)
                        {
                            lock (_allEvents)
                            {
                                // Add alerts
                                if (details.ActiveAlerts != null && details.ActiveAlerts.Count > 0)
                                {
                                    foreach (var alert in details.ActiveAlerts)
                                    {
                                        _allEvents.Add(new AlertEventDto
                                        {
                                            AlertId = alert.AlertId,
                                            PatientId = patient.PatientId,
                                            PatientName = details.Name,
                                            Timestamp = alert.CreatedAt,
                                            EventType = "Alert",
                                            IsAlert = true,
                                            Status = alert.Status,
                                            RiskLevel = alert.RiskLevel,
                                            Summary = alert.Reason
                                        });
                                    }
                                }

                                // Add comments
                                if (details.CommunicationHistory != null && details.CommunicationHistory.Count > 0)
                                {
                                    foreach (var comment in details.CommunicationHistory.Where(c => c.AuthorRole == UserRole.Patient))
                                    {
                                        _allEvents.Add(new AlertEventDto
                                        {
                                            AlertId = Guid.Empty,
                                            PatientId = patient.PatientId,
                                            PatientName = details.Name,
                                            Timestamp = comment.CreatedAt,
                                            EventType = "Comment",
                                            IsAlert = false,
                                            Status = AlertStatus.New,
                                            RiskLevel = RiskLevel.Medium,
                                            Summary = comment.Text.Length > 100 ? comment.Text[..100] + "..." : comment.Text
                                        });
                                    }
                                }
                            }
                        }
                    }
                }
                catch (HttpRequestException httpEx)
                {
                    // Network error - log but continue
                    Console.WriteLine($"Network error loading patient {patient.PatientId}: {httpEx.Message}");
                }
                catch (TaskCanceledException)
                {
                    // Timeout - log but continue
                    Console.WriteLine($"Timeout loading patient {patient.PatientId}");
                }
                catch (Exception ex)
                {
                    // Other errors - log but continue
                    Console.WriteLine($"Error loading patient {patient.PatientId}: {ex.Message}");
                }
            }).ToList();
            
            // Wait for all tasks with timeout
            try
            {
                var timeoutTask = Task.Delay(TimeSpan.FromSeconds(3), cts.Token);
                var completedTask = await Task.WhenAny(Task.WhenAll(tasks), timeoutTask);
                
                if (completedTask == timeoutTask)
                {
                    // Timeout occurred
                    _cancellationTokenSource?.Cancel();
                }
            }
            catch
            {
                // Timeout or cancellation - continue anyway
            }
        }
        catch (HttpRequestException httpEx)
        {
            _loadError = $"Unable to reach API: {httpEx.Message}. Please ensure the backend is running on http://localhost:5200";
            ToastService?.ShowError(_loadError);
        }
        catch (TaskCanceledException)
        {
            _loadError = "Request timeout. The API server may be slow or not responding.";
            ToastService?.ShowError(_loadError);
        }
        catch (Exception ex)
        {
            _loadError = $"Error loading alerts: {ex.Message}";
            ToastService?.ShowError(_loadError);
        }
        finally
        {
            // Always clear loading state, even if there was an error
            _loading = false;
            _cancellationTokenSource?.Dispose();
            _cancellationTokenSource = null;
            
            // Force UI update immediately
            StateHasChanged();
            
            // Update again after a tiny delay to ensure UI reflects changes
            _ = Task.Run(async () =>
            {
                await Task.Delay(50);
                StateHasChanged();
            });
        }
    }
    
    private void CancelLoading()
    {
        try
        {
            _cancellationTokenSource?.Cancel();
            _loading = false;
            _loadError = "Loading cancelled by user.";
            StateHasChanged();
        }
        catch
        {
            // Ignore errors in cancel
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task UpdateAlertStatus(Guid alertId, AlertStatus newStatus)
    {
        if (alertId == Guid.Empty)
        {
            return; // Can't update comment status
        }

        try
        {
            EnsureAuthHeader();
            var updateDto = new AlertStatusUpdateDto
            {
                NewStatus = newStatus,
                ClinicianNotes = $"Status updated to {newStatus}"
            };

            var response = await Http.PutAsJsonAsync($"api/clinician/alerts/{alertId}/status", updateDto);
            if (response.IsSuccessStatusCode)
            {
                var alert = _allEvents.FirstOrDefault(e => e.AlertId == alertId);
                if (alert != null)
                {
                    alert.Status = newStatus;
                    ToastService?.ShowSuccess("Alert status updated successfully.");
                    StateHasChanged();
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                ToastService?.ShowError($"Failed to update alert status: {response.StatusCode}");
            }
        }
        catch (HttpRequestException httpEx)
        {
            ToastService?.ShowError($"Network error: {httpEx.Message}");
        }
        catch (Exception ex)
        {
            ToastService?.ShowError($"Error updating alert: {ex.Message}");
        }
    }

    private bool MatchesStatus(AlertEventDto evt)
    {
        if (!_statusFilter.HasValue)
        {
            return true;
        }
        return evt.IsAlert && evt.Status == _statusFilter.Value;
    }

    private bool MatchesType(AlertEventDto evt)
    {
        if (string.IsNullOrWhiteSpace(_typeFilter))
        {
            return true;
        }
        return string.Equals(evt.EventType, _typeFilter, StringComparison.OrdinalIgnoreCase);
    }

    private bool MatchesSeverity(AlertEventDto evt)
    {
        if (!_severityFilter.HasValue)
        {
            return true;
        }
        return evt.RiskLevel == _severityFilter.Value;
    }

    private bool MatchesSearch(AlertEventDto evt)
    {
        if (string.IsNullOrWhiteSpace(_searchTerm))
        {
            return true;
        }
        var term = _searchTerm.Trim().ToLowerInvariant();
        return evt.PatientName.ToLowerInvariant().Contains(term)
            || evt.PatientId.ToString("N").ToLowerInvariant().Contains(term)
            || evt.Summary.ToLowerInvariant().Contains(term);
    }

    private static Color EventTypeColor(string eventType) => eventType switch
    {
        "Alert" => Color.Error,
        "Comment" => Color.Info,
        _ => Color.Secondary
    };

    private static Color GetRiskColor(RiskLevel risk) => risk switch
    {
        RiskLevel.Critical => Color.Error,
        RiskLevel.High => Color.Warning,
        RiskLevel.Medium => Color.Info,
        _ => Color.Success
    };

    private class AlertEventDto
    {
        public Guid AlertId { get; set; }
        public Guid PatientId { get; set; }
        public string PatientName { get; set; } = string.Empty;
        public DateTime Timestamp { get; set; }
        public string EventType { get; set; } = string.Empty;
        public bool IsAlert { get; set; }
        public AlertStatus Status { get; set; }
        public RiskLevel RiskLevel { get; set; }
        public string Summary { get; set; } = string.Empty;
    }
}


