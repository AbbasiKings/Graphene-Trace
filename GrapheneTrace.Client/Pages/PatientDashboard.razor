@page "/patient/dashboard"
@using GrapheneTrace.Client.Models
@using GrapheneTrace.Core.DTOs.Patient
@using GrapheneTrace.Core.Enums
@inject HttpClient Http
@inject AppToastService ToastService
@using System.Net.Http.Headers

@if (_loading)
{
    <div class="d-flex justify-center my-8">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
    </div>
}
else if (!string.IsNullOrEmpty(_loadError))
{
    <MudAlert Severity="Severity.Error">@_loadError</MudAlert>
}
else
{
    <MudContainer MaxWidth="MaxWidth.False" Class="pa-6 patient-dashboard">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-6">
            <div>
                <MudText Typo="Typo.h4" Class="fw-bold">Today's Foot Health</MudText>
                <MudText Typo="Typo.subtitle2" Class="text-secondary">
                    Monitor live pressure visuals, stay aware of alerts, and message your clinician with one tap.
                </MudText>
                <MudText Typo="Typo.caption" Class="text-secondary">
                    Last cloud sync: @(_dashboard?.LastFrameTimestamp?.ToLocalTime().ToString("MMM d · HH:mm:ss") ?? "—")
                </MudText>
            </div>
            <MudChip T="string" Color="Color.Success" Variant="Variant.Text">
                Connected · Sensor Pack v3
            </MudChip>
        </MudStack>

        <MudGrid Spacing="2" Class="mb-4">
            @foreach (var card in RiskCards)
            {
                <MudItem xs="12" md="6" lg="3">
                    <MudCard Class="elevation-2 h-100 risk-card">
                        <MudCardContent>
                            <MudStack Spacing="1">
                                <MudIcon Icon="@card.Icon" Color="@card.CardColor" Size="Size.Large" />
                                <MudText Typo="Typo.overline" Class="text-secondary">@card.Title</MudText>
                                <MudText Typo="Typo.h4" Class="fw-semibold">@card.Value</MudText>
                                <MudText Typo="Typo.caption">@card.Context</MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>

        <MudGrid Spacing="2">
            <MudItem xs="12" lg="7">
                <MudCard Class="elevation-2 h-100">
                    <MudCardHeader>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                            <MudStack>
                                <MudText Typo="Typo.h6">Live Foot Pressure Map</MudText>
                                <MudText Typo="Typo.caption" Class="text-secondary">
                                    Last synced @(LiveFrame.Timestamp.ToString("HH:mm:ss")) · Colors shift with pressure intensity.
                                </MudText>
                            </MudStack>
                            <MudChip T="string" Color="Color.Warning" Variant="Variant.Filled" Class="fw-semibold">
                                Current Risk: @CurrentRisk
                            </MudChip>
                        </MudStack>
                    </MudCardHeader>
                    <MudCardContent>
                        <div class="heatmap-grid">
                            @foreach (var row in LiveFrame.Values)
                            {
                                <div class="heatmap-row">
                                    @foreach (var value in row)
                                    {
                                        <div class="heatmap-cell" style="--intensity:@value;"></div>
                                    }
                                </div>
                            }
                        </div>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mt-3">
                            <MudText Typo="Typo.caption" Class="text-secondary">Next sensor refresh in 28s</MudText>
                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Refresh" OnClick="async () => await LoadDashboardAsync()">
                                Manual Refresh
                            </MudButton>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" lg="5">
                <MudCard Class="elevation-2 h-100">
                    <MudCardHeader>
                        <MudText Typo="Typo.h6">Quick Health Summary</MudText>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudList T="PatientMetricSnapshot" Dense="true">
                            @foreach (var metric in MetricSnapshots)
                            {
                                <MudListItem T="PatientMetricSnapshot">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="w-100">
                                        <MudIcon Icon="@metric.Icon" Color="@metric.TrendColor" />
                                        <MudStack>
                                            <MudText Typo="Typo.body2">@metric.Label</MudText>
                                            <MudText Typo="Typo.subtitle2" Class="fw-semibold">@metric.Value</MudText>
                                        </MudStack>
                                        <MudText Typo="Typo.caption" Color="@metric.TrendColor" Class="ms-auto">@metric.TrendLabel</MudText>
                                    </MudStack>
                                </MudListItem>
                            }
                        </MudList>
                        <MudDivider Class="my-3" />
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.subtitle1" Class="fw-semibold">Latest Alerts & Messages</MudText>
                            <MudPaper Class="pa-3 alert-card" Elevation="1">
                                <MudStack Spacing="1">
                                    <MudText Typo="Typo.caption" Class="text-secondary">
                                        @(DisplayAlert.Timestamp.ToString("MMM d · HH:mm"))
                                    </MudText>
                                    <MudText Typo="Typo.body1" Class="fw-semibold">
                                        @DisplayAlert.Title
                                    </MudText>
                                    <MudText Typo="Typo.caption">Status: @DisplayAlert.Status</MudText>
                                </MudStack>
                            </MudPaper>
                            <MudPaper Class="pa-3 message-card" Elevation="1">
                                <MudStack Spacing="1">
                                    <MudText Typo="Typo.caption" Class="text-secondary">
                                        Clinician reply · @(LatestClinicianMessage.Timestamp.ToString("MMM d · HH:mm"))
                                    </MudText>
                                    <MudText Typo="Typo.body2">@LatestClinicianMessage.Body</MudText>
                                </MudStack>
                            </MudPaper>
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Primary" 
                                       StartIcon="@Icons.Material.Filled.NoteAdd"
                                       Href="/patient/alerts">
                                Log New Discomfort
                            </MudButton>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <MudGrid Spacing="2" Class="mt-6">
            <MudItem xs="12" lg="7">
                <MudCard Class="elevation-2 h-100">
                    <MudCardHeader>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                            <MudStack>
                                <MudText Typo="Typo.h6">Upload Sensor Data</MudText>
                                <MudText Typo="Typo.caption" Class="text-secondary">
                                    Drop CSV files or browse to upload new pressure frames.
                                </MudText>
                            </MudStack>
                            <MudChip T="string" Color="Color.Info" Variant="Variant.Outlined">@($"{_selectedFiles.Count} file(s)")</MudChip>
                        </MudStack>
                    </MudCardHeader>
                    <MudCardContent>
                        <div class="@($"drop-zone {( _isDragging ? "dragging" : string.Empty)}")"
                             @ondragenter="HandleDragEnter"
                             @ondragleave="HandleDragLeave">
                            <MudText Typo="Typo.subtitle1">Drag & Drop CSV files</MudText>
                            <MudText Typo="Typo.caption" Class="text-secondary mb-2">or click to browse</MudText>
                            <InputFile OnChange="HandleFileSelection" multiple accept=".csv" />
                        </div>

                        @if (_selectedFiles.Count > 0)
                        {
                            <MudStack Spacing="1" Class="my-3">
                                @foreach (var file in _selectedFiles)
                                {
                                    <MudPaper Class="file-pill" Elevation="0">
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                            <MudText Typo="Typo.body2">@file.Name</MudText>
                                            <MudIconButton Icon="@Icons.Material.Filled.Close"
                                                           Size="Size.Small"
                                                           Color="Color.Error"
                                                           OnClick="@(() => RemoveFile(file))" />
                                        </MudStack>
                                    </MudPaper>
                                }
                            </MudStack>
                        }

                        <MudStack Spacing="2">
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       Disabled="@(_selectedFiles.Count == 0 || _uploadInProgress)"
                                       OnClick="UploadFilesAsync"
                                       StartIcon="@Icons.Material.Filled.CloudUpload">
                                @(_uploadInProgress ? "Uploading..." : "Upload & Analyze")
                            </MudButton>

                            @if (_uploadInProgress)
                            {
                                <div>
                                    <MudText Typo="Typo.subtitle2">Upload Progress</MudText>
                                    <MudProgressLinear Color="Color.Info"
                                                       Class="mb-2"
                                                       Value="@_uploadProgressValue"
                                                       Max="100"
                                                       Indeterminate="_uploadProgressValue < 100 && _uploadProgressValue > 0" />
                                    <MudText Typo="Typo.subtitle2">Analysis Progress</MudText>
                                    <MudProgressLinear Color="Color.Success"
                                                       Value="@_analysisProgressValue"
                                                       Max="100"
                                                       Indeterminate="_analysisProgressValue < 100 && _analysisProgressValue > 0" />
                                </div>
                            }
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" lg="5">
                <MudCard Class="elevation-2 h-100">
                    <MudCardHeader>
                        <MudText Typo="Typo.h6">Recent Uploads</MudText>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (_recentUploadResults.Count == 0)
                        {
                            <MudText Typo="Typo.body2" Class="text-secondary">No uploads analyzed yet.</MudText>
                        }
                        else
                        {
                            <MudList T="FileUploadResultDto" Dense="true">
                                @foreach (var summary in _recentUploadResults)
                                {
                                    <MudListItem T="FileUploadResultDto" Value="@summary">
                                        <MudStack Spacing="1">
                                            <MudText Typo="Typo.subtitle2">@summary.FileName</MudText>
                                            <MudText Typo="Typo.caption" Class="text-secondary">
                                                Frames: @summary.FramesProcessed · Alerts: @summary.AlertsRaised · Status: @summary.Status
                                            </MudText>
                                            <MudText Typo="Typo.caption">@summary.UploadedAt.ToLocalTime().ToString("MMM d · HH:mm")</MudText>
                                            @if (summary.Errors.Count > 0)
                                            {
                                                <MudAlert Severity="Severity.Warning" Dense="true">
                                                    @string.Join("; ", summary.Errors)
                                                </MudAlert>
                                            }
                                        </MudStack>
                                    </MudListItem>
                                }
                            </MudList>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    </MudContainer>
}

<PageTitle>Patient Dashboard</PageTitle>

@code {
    private List<PatientRiskCard> RiskCards { get; set; } = new()
    {
        new PatientRiskCard("Overall Status", "Monitor", "AI suggests lighter activity for the next hour", Color.Warning, Icons.Material.Filled.HealthAndSafety),
        new PatientRiskCard("Peak Pressure Index", "11.3", "High point occurred during 18:05 walk", Color.Secondary, Icons.Material.Filled.Speed),
        new PatientRiskCard("Contact Area %", "60%", "Within personalised range", Color.Success, Icons.Material.Filled.DonutLarge),
        new PatientRiskCard("Unread Alerts", "1", "Clinician replied 12 minutes ago", Color.Info, Icons.Material.Filled.MarkChatUnread)
    };

    private List<PatientMetricSnapshot> MetricSnapshots { get; set; } = new()
    {
        new PatientMetricSnapshot("Heel Pressure", "+24%", "↑ Slight increase vs baseline", Color.Warning, Icons.Material.Filled.SensorOccupied),
        new PatientMetricSnapshot("Daily Steps", "4,182", "On track for today", Color.Success, Icons.Material.Filled.DirectionsWalk),
        new PatientMetricSnapshot("Device Battery", "82%", "Approx. 18 hours left", Color.Info, Icons.Material.Filled.BatteryStd)
    };

    private HeatMapFrame LiveFrame { get; set; } = new(DateTime.Now,
        GenerateFrame(seed: 17));

    private PatientAlertDigest? LatestAlert { get; set; } = new(Guid.NewGuid(), DateTime.Now.AddMinutes(-14),
        "High pressure detected during evening walk", "Right heel", "New", Color.Error);

    private PatientMessage LatestClinicianMessage = new(Guid.NewGuid(), "Dr Harper",
        DateTime.Now.AddMinutes(-12), "Thanks for flagging the discomfort. Please use the offloading insole tonight and log how it feels tomorrow morning.", true);

    private string CurrentRisk { get; set; } = "Monitor";
    private bool _loading = true;
    private string? _loadError;
    private DashboardSummaryDto? _dashboard;
    private readonly List<IBrowserFile> _selectedFiles = new();
    private readonly List<FileUploadResultDto> _recentUploadResults = new();
    private bool _isDragging;
    private bool _uploadInProgress;
    private double _uploadProgressValue;
    private double _analysisProgressValue;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardAsync();
    }

    private async Task LoadDashboardAsync()
    {
        try
        {
            _loading = true;
            _loadError = null;
            StateHasChanged();

            _dashboard = await Http.GetFromJsonAsync<DashboardSummaryDto>("api/patient/dashboard");
            if (_dashboard is not null)
            {
                HydrateFromDashboard(_dashboard);
            }
        }
        catch (Exception)
        {
            _loadError = "Real-time patient metrics could not be loaded. Please ensure the backend API is running.";
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private void HydrateFromDashboard(DashboardSummaryDto dashboard)
    {
        CurrentRisk = dashboard.CurrentRiskIndicator.ToString();
        var timestampLabel = dashboard.LastFrameTimestamp?.ToLocalTime().ToString("MMM d · HH:mm") ?? "Awaiting first upload";

        RiskCards = new()
        {
            new PatientRiskCard("Overall Status", CurrentRisk, $"Updated {timestampLabel}", ResolveRiskColor(dashboard.CurrentRiskIndicator), Icons.Material.Filled.HealthAndSafety),
            new PatientRiskCard("Peak Pressure Index", dashboard.LatestPeakPressureIndex.ToString("F1"), "Latest processed frame", Color.Secondary, Icons.Material.Filled.Speed),
            new PatientRiskCard("Contact Area %", $"{dashboard.LatestContactAreaPercent:F1}%", "Live plantar coverage", Color.Success, Icons.Material.Filled.DonutLarge),
            new PatientRiskCard("Active Alerts", dashboard.AlertSummary.TotalAlerts.ToString(), "AI + clinician items", Color.Info, Icons.Material.Filled.MarkChatUnread)
        };

        MetricSnapshots = new()
        {
            new PatientMetricSnapshot("Heel Pressure", $"{dashboard.LatestPeakPressureIndex:F1}", "Peak pressure index", ResolveRiskColor(dashboard.CurrentRiskIndicator), Icons.Material.Filled.SensorOccupied),
            new PatientMetricSnapshot("Contact Coverage", $"{dashboard.LatestContactAreaPercent:F1}%", "Surface in optimal zone", Color.Success, Icons.Material.Filled.DonutLarge),
            new PatientMetricSnapshot("Alert Queue", $"{dashboard.AlertSummary.NewAlerts}", "Items needing review", Color.Info, Icons.Material.Filled.WarningAmber)
        };

        if (dashboard.RecentAlerts.Count > 0)
        {
            var latest = dashboard.RecentAlerts.OrderByDescending(a => a.Timestamp).First();
            LatestAlert = new PatientAlertDigest(latest.AlertId, latest.Timestamp, latest.Reason, "Pressure Sensor", latest.Status.ToString(), ResolveRiskColor(latest.RiskLevel));
        }

        if (dashboard.LastFrameTimestamp.HasValue)
        {
            LiveFrame = new HeatMapFrame(dashboard.LastFrameTimestamp.Value.ToLocalTime(), GenerateFrame(seed: dashboard.LastFrameTimestamp.Value.Second + 10));
        }

        if (dashboard.LatestClinicianReply is not null)
        {
            var reply = dashboard.LatestClinicianReply;
            LatestClinicianMessage = new PatientMessage(Guid.NewGuid(), reply.AuthorName,
                reply.Timestamp.ToLocalTime(), reply.Message, true);
        }
    }

    private PatientAlertDigest DisplayAlert => LatestAlert ?? new PatientAlertDigest(Guid.Empty, DateTime.Now, "No alerts in queue", "All Regions", "Clear", Color.Success);

    private static Color ResolveRiskColor(RiskLevel level) => level switch
    {
        RiskLevel.Critical => Color.Error,
        RiskLevel.High => Color.Warning,
        RiskLevel.Medium => Color.Info,
        _ => Color.Success
    };
    private static IReadOnlyList<IReadOnlyList<int>> GenerateFrame(int seed)
    {
        var random = new Random(seed);
        var rows = new List<IReadOnlyList<int>>(16);
        for (var r = 0; r < 16; r++)
        {
            var row = new List<int>(16);
            for (var c = 0; c < 16; c++)
            {
                var value = random.Next(8, 80);
                if (r is > 8 and < 13 && c is > 6 and < 11)
                {
                    value = random.Next(65, 99);
                }

                row.Add(value);
            }
            rows.Add(row);
        }
        return rows;
    }

    private void HandleFileSelection(InputFileChangeEventArgs e)
    {
        foreach (var file in e.GetMultipleFiles(20))
        {
            if (!file.Name.EndsWith(".csv", StringComparison.OrdinalIgnoreCase))
            {
                ToastService.ShowError($"{file.Name} is not a CSV file.");
                continue;
            }
            _selectedFiles.Add(file);
        }
        StateHasChanged();
    }

    private void HandleDragEnter() => _isDragging = true;

    private void HandleDragLeave() => _isDragging = false;

    private void RemoveFile(IBrowserFile file) => _selectedFiles.Remove(file);

    private async Task UploadFilesAsync()
    {
        if (_selectedFiles.Count == 0 || _uploadInProgress)
        {
            return;
        }

        try
        {
            _uploadInProgress = true;
            _uploadProgressValue = 15;
            _analysisProgressValue = 0;

            using var content = new MultipartFormDataContent();
            foreach (var file in _selectedFiles)
            {
                var stream = file.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024L);
                var fileContent = new StreamContent(stream);
                fileContent.Headers.ContentType = new MediaTypeHeaderValue("text/csv");
                content.Add(fileContent, "files", file.Name);
            }

            _uploadProgressValue = 60;
            _analysisProgressValue = 10;

            var response = await Http.PostAsync("api/patient/data/files", content);

            if (response.IsSuccessStatusCode)
            {
                _analysisProgressValue = 70;
                var summaries = await response.Content.ReadFromJsonAsync<List<FileUploadResultDto>>() ?? new List<FileUploadResultDto>();
                _recentUploadResults.InsertRange(0, summaries);
                _recentUploadResults.Sort((a, b) => b.UploadedAt.CompareTo(a.UploadedAt));
                if (_recentUploadResults.Count > 5)
                {
                    _recentUploadResults.RemoveRange(5, _recentUploadResults.Count - 5);
                }
                _analysisProgressValue = 100;
                _uploadProgressValue = 100;
                ToastService.ShowSuccess("Files uploaded and analyzed successfully.");
                _selectedFiles.Clear();
                await LoadDashboardAsync();
            }
            else
            {
                _analysisProgressValue = 0;
                _uploadProgressValue = 0;
                var error = await response.Content.ReadAsStringAsync();
                ToastService.ShowError($"Upload failed: {error}");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Upload failed: {ex.Message}");
        }
        finally
        {
            _uploadInProgress = false;
        }
    }
}

