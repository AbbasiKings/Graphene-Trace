@page "/admin/dashboard"
@using GrapheneTrace.Client.Services
@using GrapheneTrace.Client.Models
@using GrapheneTrace.Core.DTOs.Admin
@using GrapheneTrace.Core.Enums
@using System.Net.Http.Headers
@using System.Net.Http.Json
@inject AuthService AuthService
@inject HttpClient Http
@inject AppToastService ToastService

<PageTitle>@(_dashboardKpis?.Labels?.PageTitle ?? "Admin Dashboard")</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="pa-6">
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-6">
        <div>
            <MudText Typo="Typo.h4" Class="fw-bold">@(_dashboardKpis?.Labels?.PageTitle ?? "Admin Dashboard")</MudText>
            <MudText Typo="Typo.subtitle2" Class="text-secondary">
                @(_dashboardKpis?.Labels?.PageSubtitle ?? "Monitoring system health, usage, and recent administrative activity.")
            </MudText>
        </div>
        <MudStack Row="true" Spacing="2">
            <MudChip T="string" Color="Color.Primary">
                @AuthService.UserName (@AuthService.Role)
            </MudChip>
            <MudButton Color="Color.Error" Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.AdminPanelSettings" Href="/admin/admins">
                @(_dashboardKpis?.Labels?.ManageAdminsButton ?? "Manage Admins")
            </MudButton>
        </MudStack>
    </MudStack>

    @if (_loading)
    {
        <MudContainer Class="d-flex justify-center align-center" style="min-height: 400px;">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        </MudContainer>
    }
    else if (!string.IsNullOrEmpty(_loadError))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4">@_loadError</MudAlert>
    }
    else
    {
        <MudGrid Class="mb-6">
            <MudItem xs="12" sm="6" lg="3">
                <MudCard Class="h-100 elevation-2">
                    <MudCardContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.MedicalServices" Color="Color.Primary" Class="me-2" />
                            <MudStack>
                                <MudText Typo="Typo.subtitle2" Class="text-secondary">@(_dashboardKpis?.Labels?.ActivePatientsTitle ?? "Active Patients")</MudText>
                                <MudText Typo="Typo.h5" Class="fw-semibold">@_dashboardKpis?.TotalPatients.ToString("N0")</MudText>
                            </MudStack>
                        </MudStack>
                        <MudDivider Class="my-3" />
                        <MudText Typo="Typo.caption" Class="text-secondary">@(_dashboardKpis?.Labels?.ActivePatientsDescription ?? "Total registered patients")</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" sm="6" lg="3">
                <MudCard Class="h-100 elevation-2">
                    <MudCardContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.Groups" Color="Color.Primary" Class="me-2" />
                            <MudStack>
                                <MudText Typo="Typo.subtitle2" Class="text-secondary">@(_dashboardKpis?.Labels?.CliniciansTitle ?? "Clinicians")</MudText>
                                <MudText Typo="Typo.h5" Class="fw-semibold">@_dashboardKpis?.TotalClinicians.ToString("N0")</MudText>
                            </MudStack>
                        </MudStack>
                        <MudDivider Class="my-3" />
                        <MudText Typo="Typo.caption" Class="text-secondary">@(_dashboardKpis?.Labels?.CliniciansDescription ?? "Licensed practitioners")</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" sm="6" lg="3">
                <MudCard Class="h-100 elevation-2">
                    <MudCardContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.Storage" Color="Color.Primary" Class="me-2" />
                            <MudStack>
                                <MudText Typo="Typo.subtitle2" Class="text-secondary">@(_dashboardKpis?.Labels?.DataVolumeTitle ?? "Data Volume")</MudText>
                                <MudText Typo="Typo.h5" Class="fw-semibold">@FormatFrames(_dashboardKpis?.TotalFramesStored ?? 0)</MudText>
                            </MudStack>
                        </MudStack>
                        <MudDivider Class="my-3" />
                        <MudText Typo="Typo.caption" Class="text-secondary">@(_dashboardKpis?.Labels?.DataVolumeDescription ?? "Total pressure frames stored")</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" sm="6" lg="3">
                <MudCard Class="h-100 elevation-2">
                    <MudCardContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.NotificationsActive" Color="Color.Primary" Class="me-2" />
                            <MudStack>
                                <MudText Typo="Typo.subtitle2" Class="text-secondary">@(_dashboardKpis?.Labels?.ActiveAlertsTitle ?? "Active Alerts")</MudText>
                                <MudText Typo="Typo.h5" Class="fw-semibold">@_dashboardKpis?.ActiveAlerts.ToString("N0")</MudText>
                            </MudStack>
                        </MudStack>
                        <MudDivider Class="my-3" />
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.caption" Class="text-secondary">@(_dashboardKpis?.Labels?.ActiveAlertsDescription ?? "Unresolved alerts in system")</MudText>
                            <MudText Typo="Typo.caption" Class="text-secondary">
                                Total: @(_dashboardKpis?.TotalAlerts.ToString("N0") ?? "0")
                                @if (_dashboardKpis?.TotalAlerts > 0)
                                {
                                    <span> | New: @(_dashboardKpis?.NewAlerts.ToString("N0") ?? "0") | In Review: @(_dashboardKpis?.InReviewAlerts.ToString("N0") ?? "0")</span>
                                    @if (_dashboardKpis?.ResolvedAlerts > 0 || _dashboardKpis?.AutoClearedAlerts > 0)
                                    {
                                        <span> | Resolved: @(_dashboardKpis?.ResolvedAlerts.ToString("N0") ?? "0") | Auto-Cleared: @(_dashboardKpis?.AutoClearedAlerts.ToString("N0") ?? "0")</span>
                                    }
                                }
                            </MudText>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

    <MudGrid Class="mb-6">
        <MudItem xs="12" md="7">
            <MudCard Class="h-100 elevation-2">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">@(_dashboardKpis?.Labels?.SystemOverviewTitle ?? "System Overview")</MudText>
                    <MudText Typo="Typo.caption" Class="text-secondary">@(_dashboardKpis?.Labels?.SystemOverviewSubtitle ?? "Total users and system statistics")</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Spacing="3">
                        <MudText Typo="Typo.h4">@_dashboardKpis?.TotalUsers.ToString("N0")</MudText>
                        <MudText Typo="Typo.body2" Class="text-secondary">@(_dashboardKpis?.Labels?.TotalUsersLabel ?? "Total Users in System")</MudText>
                        @if (_dashboardKpis?.LastDataReceived.HasValue == true)
                        {
                            <MudDivider />
                            <MudText Typo="Typo.body2">
                                <MudText Typo="Typo.caption" Class="text-secondary">@(_dashboardKpis?.Labels?.LastDataReceivedLabel ?? "Last Data Received: ")</MudText>
                                @_dashboardKpis.LastDataReceived.Value.ToString("yyyy-MM-dd HH:mm:ss")
                            </MudText>
                        }
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" md="5">
            <MudCard Class="h-100 elevation-2">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">@(_dashboardKpis?.Labels?.SystemStatusTitle ?? "System Status")</MudText>
                    <MudText Typo="Typo.caption" Class="text-secondary">@(_dashboardKpis?.Labels?.SystemStatusSubtitle ?? "Current system health indicators")</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Spacing="2">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.body2">@(_dashboardKpis?.Labels?.TotalUsersStatusLabel ?? "Total Users")</MudText>
                            <MudChip T="int" Color="Color.Success" Size="Size.Small">@(_dashboardKpis?.TotalUsers ?? 0)</MudChip>
                        </MudStack>
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.body2">@(_dashboardKpis?.Labels?.ActiveAlertsStatusLabel ?? "Active Alerts")</MudText>
                            <MudChip T="int" Color="@(_dashboardKpis?.ActiveAlerts > 0 ? Color.Warning : Color.Success)" Size="Size.Small">@(_dashboardKpis?.ActiveAlerts ?? 0)</MudChip>
                        </MudStack>
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.body2">@(_dashboardKpis?.Labels?.DataFramesStatusLabel ?? "Data Frames")</MudText>
                            <MudChip T="string" Color="Color.Info" Size="Size.Small">@FormatFrames(_dashboardKpis?.TotalFramesStored ?? 0)</MudChip>
                        </MudStack>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <MudCard Class="elevation-2">
        <MudCardHeader>
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                <MudStack>
                    <MudText Typo="Typo.h6">@(_dashboardKpis?.Labels?.RecentAuditActivityTitle ?? "Recent Audit Activity")</MudText>
                    <MudText Typo="Typo.caption" Class="text-secondary">
                        @(_dashboardKpis?.Labels?.RecentAuditActivitySubtitle ?? "Ten most recent administrative and security events")
                    </MudText>
                </MudStack>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" Href="/admin/configuration">
                    @(_dashboardKpis?.Labels?.ViewAuditConsoleButton ?? "View Audit Console")
                </MudButton>
            </MudStack>
        </MudCardHeader>
        <MudCardContent Class="pt-0">
            @if (_auditLogs == null || _auditLogs.Count == 0)
            {
                <MudText Typo="Typo.body2" Class="text-secondary">@(_dashboardKpis?.Labels?.NoAuditLogsMessage ?? "No audit logs available.")</MudText>
            }
            else
            {
                <MudTable T="SystemAuditLogDto" Dense="true" Hover="true" Bordered="false" Items="@_auditLogs">
                    <HeaderContent>
                        <MudTh>@(_dashboardKpis?.Labels?.TableHeaderWhen ?? "When")</MudTh>
                        <MudTh>@(_dashboardKpis?.Labels?.TableHeaderUser ?? "User")</MudTh>
                        <MudTh>@(_dashboardKpis?.Labels?.TableHeaderAction ?? "Action")</MudTh>
                        <MudTh>@(_dashboardKpis?.Labels?.TableHeaderTarget ?? "Target")</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="@(_dashboardKpis?.Labels?.TableHeaderWhen ?? "When")">@context.CreatedAt.ToString("yyyy-MM-dd HH:mm")</MudTd>
                        <MudTd DataLabel="@(_dashboardKpis?.Labels?.TableHeaderUser ?? "User")">@context.ActorName</MudTd>
                        <MudTd DataLabel="@(_dashboardKpis?.Labels?.TableHeaderAction ?? "Action")">@context.Action</MudTd>
                        <MudTd DataLabel="@(_dashboardKpis?.Labels?.TableHeaderTarget ?? "Target")">@context.TargetEntity</MudTd>
                    </RowTemplate>
                </MudTable>
            }
        </MudCardContent>
    </MudCard>
    }
</MudContainer>

@code {
    private bool _loading = true;
    private string? _loadError;
    private DashboardKpiDto? _dashboardKpis;
    private List<SystemAuditLogDto> _auditLogs = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardDataAsync();
    }

    private void EnsureAuthHeader()
    {
        if (!string.IsNullOrEmpty(AuthService.Token))
        {
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", AuthService.Token);
        }
    }

    private async Task LoadDashboardDataAsync()
    {
        _loading = true;
        _loadError = null;
        StateHasChanged();

        try
        {
            EnsureAuthHeader();

            // Load Dashboard KPIs
            var kpiResponse = await Http.GetAsync("api/admin/dashboard");
            if (kpiResponse.IsSuccessStatusCode)
            {
                _dashboardKpis = await kpiResponse.Content.ReadFromJsonAsync<DashboardKpiDto>();
            }
            else
            {
                _loadError = $"Failed to load dashboard data: {kpiResponse.StatusCode}";
                ToastService?.ShowError(_loadError);
            }

            // Load Audit Logs
            var auditResponse = await Http.GetAsync("api/admin/audit?limit=10");
            if (auditResponse.IsSuccessStatusCode)
            {
                var logs = await auditResponse.Content.ReadFromJsonAsync<List<SystemAuditLogDto>>();
                _auditLogs = logs ?? new List<SystemAuditLogDto>();
            }
        }
        catch (HttpRequestException httpEx)
        {
            _loadError = $"Cannot connect to API server. Please ensure the backend is running. Error: {httpEx.Message}";
            ToastService?.ShowError(_loadError);
        }
        catch (Exception ex)
        {
            _loadError = $"Error loading dashboard: {ex.Message}";
            ToastService?.ShowError(_loadError);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private string FormatFrames(long frames)
    {
        if (frames >= 1_000_000)
        {
            return $"{frames / 1_000_000.0:F1}M frames";
        }
        if (frames >= 1_000)
        {
            return $"{frames / 1_000.0:F1}K frames";
        }
        return $"{frames} frames";
    }
}

