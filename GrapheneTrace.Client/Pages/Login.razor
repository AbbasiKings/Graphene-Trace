@page "/"
@page "/login"
@layout AuthenticationLayout
@using GrapheneTrace.Core.Enums
@using GrapheneTrace.Client.Services
@using System.ComponentModel.DataAnnotations
@inject AppToastService ToastService
@inject NavigationManager NavigationManager
@inject AuthService AuthService

<div class="w-full flex justify-center">
    <section class="w-[400px] max-w-lg">
        <div class="bg-white shadow-2xl rounded-3xl border border-slate-100 px-8 py-10 space-y-8">
            <header class="space-y-2 text-center md:text-left">
                <p class="uppercase tracking-[0.3em] text-[11px] text-slate-400">Access Portal</p>
                <h2 class="text-3xl font-semibold text-slate-800">Sign in to your account</h2>
                <p class="text-sm text-slate-500">Use your organization email and password to continue.</p>
            </header>

            <div class="space-y-6">
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-slate-700" for="email">Email address</label>
                    <input id="email"
                            type="email"
                            class="w-full rounded-xl border border-slate-300 px-4 py-3 text-slate-700 placeholder-slate-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="you@organization.com"
                            @bind="Email"
                            maxlength="100" />
                    <p class="text-xs text-slate-500">Enter the email associated with your GrapheneTrace account.</p>
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-slate-700" for="password">Password</label>
                    <input id="password"
                            type="password"
                            class="w-full rounded-xl border border-slate-300 px-4 py-3 text-slate-700 placeholder-slate-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Enter your password"
                            @bind="Password"
                            maxlength="50" />
                    <p class="text-xs text-slate-500">Minimum of 6 characters with case sensitivity.</p>
                </div>
            </div>

            <div class="space-y-4">
                <button class="w-full rounded-xl bg-blue-600 text-white font-semibold tracking-wide py-3 shadow-lg hover:bg-blue-700 transition" @onclick="Authenticate">Login</button>
                <a href="/reset-password" class="w-full text-center inline-flex justify-center items-center rounded-xl border border-slate-300 text-slate-600 font-semibold py-3 hover:bg-slate-100 transition">Forgot Password</a>
            </div>
        </div>
    </section>
</div>

@code {
    private string Email { get; set; } = string.Empty;
    private string Password { get; set; } = string.Empty;
    private string Message { get; set; } = string.Empty;
    private bool LoginSuccess { get; set; } = false;

    private bool CheckInputs()
    {
        if (string.IsNullOrWhiteSpace(Email))
        {
            Message = "Email cannot be empty.";
            return false;
        }
        if (!new EmailAddressAttribute().IsValid(Email))
        {
            Message = "Invalid email format.";
            return false;
        }
        if (Email.Length > 100)
        {
            Message = "Email is too long (max 100 chars).";
            return false;
        }

        if (string.IsNullOrWhiteSpace(Password))
        {
            Message = "Password cannot be empty.";
            return false;
        }
        if (Password.Length < 6)
        {
            Message = "Password must be at least 6 characters.";
            return false;
        }
        if (Password.Length > 50)
        {
            Message = "Password too long (max 50 chars).";
            return false;
        }

        return true;
    }

    private async Task Authenticate()
    {
        Message = string.Empty;
        LoginSuccess = false;

        if (!CheckInputs())
        {
            ToastService.ShowError(Message);
            return;
        }

        var requestDto = new LoginRequestDto
        {
            Email = Email.Trim(),
            Password = Password.Trim()
        };

        var responseDto = await AuthService.LoginAsync(requestDto);

        if (responseDto.Status)
        {
            LoginSuccess = true;
            ToastService.ShowSuccess($"Login successful! Welcome, {responseDto.UserName}.");

            var redirectPath = responseDto.Role switch
            {
                UserRole.Admin => "/admin/dashboard",
                UserRole.Clinician => "/clinician/dashboard",
                UserRole.Patient => "/patient/dashboard",
                _ => "/"
            };

            NavigationManager.NavigateTo(redirectPath);
        }
        else
        {
            ToastService.ShowError(responseDto.Message);
        }
    }
}

